{% extends "base.html" %}

{% block content %}
<style>
    :root {
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --warning-color: #ffc107;
        --info-color: #0dcaf0;
        --dark-color: #212529;
        --light-bg: #f8f9fa;
        --card-bg: #ffffff;
        --chat-me: #e8e8e4;
        /* Admin/Lawyer color */
        --chat-other: #e1b107;
        /* Client color */
    }

    body {
        background-color: var(--light-bg);
    }

    /* Common Cards */
    .dashboard-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        background: var(--card-bg);
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 1.5rem;
    }

    .card-header-tabs {
        background: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0 1rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--secondary-color);
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
        background: transparent;
    }

    /* Sticky Profile */
    .sticky-profile {
        position: sticky;
        top: 20px;
        z-index: 100;
    }

    /* Chat Styling */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 500px;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .chat-bubble {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        position: relative;
        font-size: 0.95rem;
    }

    .chat-me {
        background-color: var(--chat-me);
        color: black;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
        margin-left: auto;
    }

    .chat-other {
        background-color: var(--chat-other);
        color: black;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }

    /* Animations */
    .fade-in {
        animation: fadeIn 0.4s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- LEFT COLUMN: Sticky Profile & Quick Actions -->
        <div class="col-lg-3">
            <div class="sticky-profile">
                <!-- Profile Card -->
                <div class="dashboard-card text-center p-4 mb-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 shadow-sm"
                        style="width: 80px; height: 80px; font-size: 2rem;">
                        {{ client.nombre[0] }}{{ client.nombre.split()[1][0] if client.nombre.split()|length > 1 else ''
                        }}
                    </div>
                    <h5 class="fw-bold mb-1">{{ client.nombre }}</h5>
                    <p class="text-muted small mb-2">{{ client.email }}</p>
                    <span
                        class="badge rounded-pill bg-{{ 'success' if client.estado in ['Radicado', 'Finalizado', 'Con_Contrato', 'Finalizado_Proceso_Credito'] else 'warning' }} px-3 py-2 mb-3">
                        {{ client.estado.replace('_', ' ') }}
                    </span>

                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#editGeneralInfoModal">
                            <i class="bi bi-pencil-square"></i> Editar Perfil
                        </button>
                        {% if current_user.rol in ['Analista', 'Aliado', 'Abogado', 'Admin', 'Radicador'] %}
                        <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal"
                            data-bs-target="#appointmentModal">
                            <i class="bi bi-calendar-plus"></i> Agendar Cita
                        </button>
                        {% endif %}
                    </div>

                    <hr class="my-3">

                    <div class="text-start small">
                        <div class="mb-2"><i class="bi bi-telephone me-2 text-primary"></i> {{ client.telefono }}</div>
                        <div class="mb-2"><i class="bi bi-card-heading me-2 text-primary"></i> {{ client.tipo_id }} {{
                            client.numero_id }}</div>
                        <div class="mb-2"><i class="bi bi-geo-alt me-2 text-primary"></i> {{ client.ciudad }}</div>
                        <div class="mb-2"><i class="bi bi-file-earmark-lock me-2 text-primary"></i> Contrato: <strong>{{
                                client.contract_number or 'Pendiente' }}</strong></div>
                        <div class="mb-2"><i class="bi bi-person-badge me-2 text-primary"></i> Analista: {{
                            client.analista.nombre_completo if client.analista else 'N/A' }}</div>
                        <div class="mb-2"><i class="bi bi-person-badge me-2 text-primary"></i> Radicador: {{
                            client.radicador.nombre_completo if client.radicador else 'N/A' }}</div>
                    </div>
                </div>

                <!-- Status Actions -->
                {% if current_user.rol in ['Admin', 'Abogado'] %}
                <div class="dashboard-card p-3 mb-3">
                    <h6 class="fw-bold border-bottom pb-2 mb-3">Cambiar Estado</h6>
                    <form action="{{ url_for('main.update_status', client_id=client.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <select class="form-select form-select-sm mb-3" name="new_status">
                            {% if current_user.rol == 'Admin' %}
                            <option value="Pendiente_Analisis" {% if client.estado=='Pendiente_Analisis' %}selected{%
                                endif %}>Pendiente Análisis</option>
                            <option value="Con_Contrato" {% if client.estado=='Con_Contrato' %}selected{% endif %}>Con
                                Contrato</option>
                            <option value="Finalizado_Proceso_Credito" {% if client.estado=='Finalizado_Proceso_Credito'
                                %}selected{% endif %}>Finalizado Proceso de Crédito</option>
                            {% elif current_user.rol == 'Abogado' %}
                            <option value="Pendiente_Analisis" {% if client.estado=='Pendiente_Analisis' %}selected{%
                                endif %}>Pendiente Análisis</option>
                            <option value="Con_Analisis" {% if client.estado=='Con_Analisis' %}selected{% endif %}>Con
                                Análisis</option>
                            <option value="Con_Contrato" {% if client.estado=='Con_Contrato' %}selected{% endif %}>Con
                                Contrato</option>
                            <option value="Radicado" {% if client.estado=='Radicado' %}selected{% endif %}>Radicado
                            </option>
                            <option value="Finalizado" {% if client.estado=='Finalizado' %}selected{% endif %}>
                                Finalizado</option>
                            <option value="Finalizado_Proceso_Credito" {% if client.estado=='Finalizado_Proceso_Credito'
                                %}selected{% endif %}>Finalizado Proceso de Crédito</option>
                            <option value="Suspendido_Pago" {% if client.estado=='Suspendido_Pago' %}selected{% endif
                                %}>
                                Suspendido por Pago</option>
                            <option value="Finalizado_Exitoso" {% if client.estado=='Finalizado_Exitoso' %}selected{%
                                endif %}>Finalizado Exitoso</option>
                            <option value="Cerrado_Pago" {% if client.estado=='Cerrado_Pago' %}selected{% endif %}>
                                Cerrado por Pago</option>
                            {% endif %}
                        </select>
                        <button type="submit" class="btn btn-dark btn-sm w-100">Actualizar</button>
                    </form>
                </div>
                {% endif %}

                {% if current_user.rol in ['Admin', 'Abogado'] %}
                <div class="dashboard-card p-3 mb-3">
                    <h6 class="fw-bold border-bottom pb-2 mb-3">Asignar Radicador</h6>
                    <form action="{{ url_for('main.assign_radicador', client_id=client.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <select class="form-select form-select-sm mb-3" name="radicador_id">
                            <option value="">Seleccionar...</option>
                            {% for rad in radicadores %}
                            <option value="{{ rad.id }}" {% if client.radicador_id==rad.id %}selected{% endif %}>{{
                                rad.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-dark btn-sm w-100">Asignar</button>
                    </form>
                </div>
                {% endif %}

                {% if current_user.rol == 'Admin' %}
                <div class="dashboard-card p-3">
                    <h6 class="fw-bold border-bottom pb-2 mb-3">Acceso Portal</h6>
                    {% if client.login_user_id and client.login_user.is_active %}
                    <div class="alert alert-success py-2 px-3 small mb-2">
                        <i class="bi bi-check-circle me-1"></i> Habilitado<br>
                        <strong>{{ client.login_user.email }}</strong>
                    </div>
                    <form action="{{ url_for('admin.revoke_client_access', client_id=client.id) }}" method="POST"
                        onsubmit="return confirm('¿Estás seguro de que deseas denegar el acceso a este cliente?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-danger btn-sm w-100">Denegar Acceso</button>
                    </form>
                    {% else %}
                    {% if client.login_user_id and not client.login_user.is_active %}
                    <div class="alert alert-danger py-2 px-3 small mb-2">
                        <i class="bi bi-shield-lock me-1"></i> Acceso Revocado
                    </div>
                    {% endif %}
                    <form action="{{ url_for('admin.generate_client_access', client_id=client.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-success btn-sm w-100">Generar Acceso</button>
                    </form>
                    {% endif %}
                </div>

                {% endif %}

                <!-- Analyst/Aliado Send to Lawyer -->
                {% if (current_user.rol == 'Analista' or current_user.rol == 'Aliado' or current_user.rol ==
                'Radicador') and client.estado in ['Nuevo',
                'Informacion_Incompleta'] %}
                <div class="dashboard-card p-3 bg-warning bg-opacity-10">
                    <h6 class="fw-bold">Próximo Paso</h6>
                    <p class="small text-muted mb-2">Enviar a revisión legal una vez completado.</p>
                    <form
                        action="{{ url_for('analyst.send_to_lawyer', client_id=client.id) if current_user.rol == 'Analista' else (url_for('radicador.send_to_lawyer', client_id=client.id) if current_user.rol == 'Radicador' else url_for('aliados.send_to_lawyer', client_id=client.id)) }}"
                        method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-dark btn-sm w-100">Enviar a Abogado</button>
                    </form>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- RIGHT COLUMN: Main Content Tabs -->
        <div class="col-lg-9">
            <div class="dashboard-card">
                <div class="card-header-tabs">
                    <ul class="nav nav-tabs card-header-tabs" id="clientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                data-bs-target="#overview" type="button" role="tab">Resumen & Análisis</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial"
                                type="button" role="tab">Financiero</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs"
                                type="button" role="tab">Documentos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat"
                                type="button" role="tab">Comunicación</button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-4">
                    <div class="tab-content" id="clientTabsContent">

                        <!-- TAB 1: OVERVIEW & ANALYSIS -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <h5 class="fw-bold text-dark mb-3">Motivo de Consulta</h5>
                                    <div class="p-3 bg-light rounded border-start border-4 border-info">
                                        {{ client.motivo_consulta }}
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <h5 class="fw-bold text-dark mb-3 mt-2">Conclusión del Análisis</h5>
                                    {% if current_user.rol in ['Analista', 'Abogado', 'Aliado'] %}
                                    <form action="{{ url_for('main.update_analysis', client_id=client.id) }}"
                                        method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <div class="form-floating mb-3">
                                            <textarea class="form-control" name="conclusion_analisis"
                                                id="conclusionInput"
                                                style="height: 120px">{{ client.conclusion_analisis or '' }}</textarea>
                                            <label for="conclusionInput">Escribe el análisis profesional...</label>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary btn-sm"><i
                                                    class="bi bi-save"></i>
                                                Guardar Análisis</button>
                                        </div>
                                    </form>
                                    {% else %}
                                    <div class="p-3 bg-light rounded">
                                        {{ client.conclusion_analisis or 'Sin análisis registrado.' }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: FINANCIALS -->
                        <div class="tab-pane fade" id="financial" role="tabpanel">
                            {% set can_edit_financials = current_user.rol in ['Abogado', 'Aliado', 'Admin', 'Radicador']
                            %}
                            {% set is_restricted = current_user.rol not in ['Analista', 'Abogado', 'Aliado', 'Admin'] %}
                            {% set installments_check = client.payment_contract.installments if client.payment_contract
                            else [] %}
                            {% set has_mora = installments_check | selectattr('estado', 'equalto', 'En Mora') | list |
                            length > 0 %}

                            <!-- Obligations -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold mb-0">Obligaciones Financieras</h5>
                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#addObligationForm"><i class="bi bi-plus-lg"></i> Agregar</button>
                            </div>

                            <div class="collapse mb-4" id="addObligationForm">
                                <div class="card card-body bg-light border-0">
                                    <form action="{{ url_for('main.add_financial_obligation', client_id=client.id) }}"
                                        method="POST" class="row g-3">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Entidad</label>
                                            <input type="text" class="form-control form-control-sm" name="entidad"
                                                required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Estado Deuda</label>
                                            <select class="form-select form-select-sm" name="estado" required>
                                                <option value="Al día">Al día</option>
                                                <option value="Mora">Mora</option>
                                                <option value="Castigada">Castigada</option>
                                                <option value="Reportado">Reportado</option>
                                                <option value="Juridico">Jurídico</option>
                                                <option value="Dudoso recaudo">Dudoso recaudo</option>
                                                <option value="Recuperado">Recuperado</option>
                                                <option value="Penalizado">Penalizado</option>
                                                <option value="Comparendos">Comparendos</option>
                                                <option value="Negociación">Negociación</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small fw-bold">Valor</label>
                                            <input type="number" class="form-control form-control-sm" name="valor"
                                                required>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="submit"
                                                class="btn btn-primary btn-sm mt-4 w-100">Guardar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="row g-3 mb-5">
                                {% for obligation in client.financial_obligations %}
                                <div class="col-md-6">
                                    <div class="border rounded p-3 position-relative h-100">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold text-primary">{{ obligation.entidad }}</span>
                                            <span class="badge bg-light text-dark border">{{ obligation.estado }}</span>
                                        </div>
                                        <h5 class="mt-2 mb-3">${{ "{:,.0f}".format(obligation.valor) }}</h5>

                                        <div class="mb-1 small fw-bold">Gestión Legal:</div>
                                        <form
                                            action="{{ url_for('main.update_legal_status', obligation_id=obligation.id) }}"
                                            method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                            <select class="form-select form-select-sm" name="estado_legal"
                                                onchange="this.form.submit()">
                                                <option value="Sin Iniciar" {% if obligation.estado_legal=='Sin Iniciar'
                                                    %}selected{% endif %}>Sin Iniciar</option>
                                                <option value="Derecho de aclaración" {% if
                                                    obligation.estado_legal=='Derecho de aclaración' %}selected{% endif
                                                    %}>
                                                    Derecho de aclaración</option>
                                                <option value="Refutación de pruebas" {% if
                                                    obligation.estado_legal=='Refutación de pruebas' %}selected{% endif
                                                    %}>
                                                    Refutación de pruebas</option>
                                                <option value="Derecho de petición" {% if
                                                    obligation.estado_legal=='Derecho de petición' %}selected{% endif
                                                    %}>
                                                    Derecho de petición</option>
                                                <option value="Fallo al derecho" {% if
                                                    obligation.estado_legal=='Fallo al derecho' %}selected{% endif %}>
                                                    Fallo al derecho</option>
                                                <option value="Refutación a ese fallo" {% if
                                                    obligation.estado_legal=='Refutación a ese fallo' %}selected{% endif
                                                    %}>
                                                    Refutación a ese fallo</option>
                                                <option value="Solicitud de reposición" {% if
                                                    obligation.estado_legal=='Solicitud de reposición' %}selected{%
                                                    endif %}>Solicitud de reposición</option>
                                                <option value="Queja superintendencia" {% if
                                                    obligation.estado_legal=='Queja superintendencia' %}selected{% endif
                                                    %}>
                                                    Queja superintendencia</option>
                                                <option value="Queja defensoría" {% if
                                                    obligation.estado_legal=='Queja defensoría' %}selected{% endif %}>
                                                    Queja defensoría</option>
                                                <option value="Tutelas fallo" {% if
                                                    obligation.estado_legal=='Tutelas fallo' %}selected{% endif %}>
                                                    Tutelas fallo</option>
                                                <option value="Tutela" {% if obligation.estado_legal=='Tutela'
                                                    %}selected{% endif %}>Tutela</option>
                                                <option value="Demanda juzgado" {% if
                                                    obligation.estado_legal=='Demanda juzgado' %}selected{% endif %}>
                                                    Demanda juzgado</option>
                                                <option value="Demanda a la SIC" {% if
                                                    obligation.estado_legal=='Demanda a la SIC' %}selected{% endif %}>
                                                    Demanda a la SIC</option>
                                                <option value="Negociación en curso" {% if
                                                    obligation.estado_legal=='Negociación en curso' %}selected{% endif
                                                    %}>
                                                    Negociación en curso</option>
                                                <option value="Negociación entregada" {% if
                                                    obligation.estado_legal=='Negociación entregada' %}selected{% endif
                                                    %}>
                                                    Negociación entregada</option>
                                                <option value="Negociación incumplida por el cliente" {% if
                                                    obligation.estado_legal=='Negociación incumplida por el cliente'
                                                    %}selected{% endif %}>Negociación incumplida por el cliente</option>
                                                <option value="Finalizado" {% if obligation.estado_legal=='Finalizado'
                                                    %}selected{% endif %}>Finalizado</option>
                                            </select>
                                        </form>
                                    </div>
                                </div>
                                {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center py-3">No hay obligaciones registradas.</p>
                                </div>
                                {% endfor %}
                            </div>

                            <hr>

                            <!-- Payment Diagnosis -->
                            <h5 class="fw-bold mb-3">Diagnóstico Inicial</h5>
                            <form action="{{ url_for('lawyer.save_payment_diagnosis', client_id=client.id) }}"
                                method="POST" class="mb-5">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <fieldset {% if not can_edit_financials %}disabled{% endif %}>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label small">Valor</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="number" step="0.01" class="form-control" name="valor"
                                                    value="{{ client.payment_diagnosis.valor if client.payment_diagnosis else '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Fecha</label>
                                            <input type="date" class="form-control form-control-sm" name="fecha_pago"
                                                value="{{ client.payment_diagnosis.fecha_pago if client.payment_diagnosis else '' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Método</label>
                                            <select class="form-select form-select-sm" name="metodo_pago">
                                                <option value="" selected disabled>-</option>
                                                {% for metodo in ['Nequi', 'Daviplata', 'Bancolombia', 'Link de pago',
                                                'Efectivo'] %}
                                                <option value="{{ metodo }}" {% if client.payment_diagnosis and
                                                    client.payment_diagnosis.metodo_pago==metodo %}selected{% endif %}>
                                                    {{ metodo }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            {% if can_edit_financials %}
                                            <button type="submit" class="btn btn-primary btn-sm w-100">Guardar</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if current_user.rol in ['Admin', 'Abogado'] %}
                                    <div class="form-check mt-2 small">
                                        <input class="form-check-input" type="checkbox" name="verificado"
                                            id="checkVerificado" {% if client.payment_diagnosis and
                                            client.payment_diagnosis.verificado %}checked{% endif %}>
                                        <label class="form-check-label" for="checkVerificado">Pago Verificado</label>
                                    </div>
                                    {% endif %}
                                </fieldset>
                            </form>

                            <!-- Contract -->
                            <h5 class="fw-bold mb-3">Contrato</h5>
                            {% if has_mora %}
                            <div class="alert alert-danger border-danger shadow-sm mb-3">
                                <h5 class="alert-heading fw-bold"><i class="bi bi-exclamation-circle-fill me-2"></i>Pago
                                    Atrasado Detectado</h5>
                                <p class="mb-0">Este cliente tiene cuotas vencidas que no han sido registradas como
                                    pagadas. El estado ha cambiado automáticamente a <strong>En Mora</strong>.</p>
                            </div>
                            {% endif %}
                            <form action="{{ url_for('lawyer.save_contract_details', client_id=client.id) }}"
                                method="POST" id="contractForm">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <fieldset {% if not can_edit_financials %}disabled{% endif %}>
                                    <div
                                        class="bg-light p-3 rounded mb-3 d-flex justify-content-between align-items-center">
                                        <div>
                                            <label class="small fw-bold">Valor Total:</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text border-0 bg-transparent">$</span>
                                                <input type="number"
                                                    class="form-control border-0 bg-transparent fw-bold"
                                                    name="valor_total" id="valorTotalContract"
                                                    value="{{ client.payment_contract.valor_total if client.payment_contract else '' }}"
                                                    style="width: 120px;">
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">Recaudo</small>
                                            <h4 class="text-success m-0" id="porcentajeDisplay">0%</h4>
                                            <input type="hidden" name="numero_cuotas" value="6">
                                        </div>
                                    </div>

                                    <div id="dynamicInstallmentsContainer">
                                        {# Sort installments by numero_cuota to ensure order #}
                                        <div class="table-responsive">
                                            <table class="table table-sm align-middle" id="installmentsTable">
                                                <thead>
                                                    <tr class="text-muted small">
                                                        <th style="width: 150px;">Concepto</th>
                                                        <th>Valor</th>
                                                        <th>Fecha</th>
                                                        <th>Método</th>
                                                        <th>Estado</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% set installments =
                                                    client.payment_contract.installments|sort(attribute='numero_cuota')
                                                    if client.payment_contract and client.payment_contract.installments
                                                    else [] %}

                                                    {# Render existing installments #}
                                                    {% for inst in installments %}
                                                    <tr data-index="{{ inst.numero_cuota }}">
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm"
                                                                name="cuota_{{ inst.numero_cuota }}_concepto"
                                                                value="{{ inst.concepto or 'Cuota ' ~ inst.numero_cuota }}">
                                                        </td>
                                                        <td>
                                                            <input type="number" class="form-control form-control-sm"
                                                                name="cuota_{{ inst.numero_cuota }}_valor"
                                                                value="{{ inst.valor }}" placeholder="$">
                                                        </td>
                                                        <td>
                                                            <input type="date" class="form-control form-control-sm"
                                                                name="cuota_{{ inst.numero_cuota }}_fecha"
                                                                value="{{ inst.fecha_vencimiento if inst.fecha_vencimiento else '' }}">
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm"
                                                                name="cuota_{{ inst.numero_cuota }}_metodo">
                                                                <option value="" disabled {% if not inst.metodo_pago
                                                                    %}selected{% endif %}>-</option>
                                                                {% for m in ['Nequi', 'Daviplata', 'Bancolombia', 'Link
                                                                de pago', 'Efectivo'] %}
                                                                <option value="{{ m }}" {% if inst.metodo_pago==m
                                                                    %}selected{% endif %}>{{ m }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm"
                                                                name="cuota_{{ inst.numero_cuota }}_estado">
                                                                <option value="Pendiente" {% if inst.estado=='Pendiente'
                                                                    %}selected{% endif %}>Pendiente</option>
                                                                <option value="Pagada" {% if inst.estado=='Pagada'
                                                                    %}selected{% endif %}>Pagada</option>
                                                                <option value="En Mora" {% if inst.estado=='En Mora'
                                                                    %}selected{% endif %}>Mora</option>
                                                                <option value="Anulada" {% if inst.estado=='Anulada'
                                                                    %}selected{% endif %}>Anulada</option>
                                                            </select>
                                                        </td>
                                                        <td class="text-end">
                                                            {# Optional: Delete button logic if desired, for now keeping
                                                            simple #}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>

                                            {% if can_edit_financials %}
                                            <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                                                id="btnAddQuota">
                                                <i class="bi bi-plus-circle"></i> Agregar Pagos
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if can_edit_financials %}
                                    <div class="text-end mt-3">
                                        <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i>
                                            Guardar Cambios</button>
                                    </div>
                                    {% endif %}
                                </fieldset>
                            </form>

                        </div>

                        <!-- TAB 3: DOCUMENTS -->
                        <div class="tab-pane fade" id="docs" role="tabpanel">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="p-4 border rounded border-dashed text-center bg-light">
                                        <h6 class="text-muted"><i
                                                class="bi bi-cloud-upload display-6 d-block mb-3"></i>Subir Nuevo
                                            Archivo</h6>
                                        <form action="{{ url_for('main.upload_file', client_id=client.id) }}"
                                            method="POST" enctype="multipart/form-data"
                                            class="d-inline-block text-start" style="max-width: 400px;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                            <div class="input-group mb-2">
                                                <input type="file" class="form-control" name="file" required>
                                                <button class="btn btn-primary" type="submit">Subir</button>
                                            </div>
                                            {% if current_user.rol == 'Abogado' %}
                                            <div class="d-flex gap-3 justify-content-center">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox"
                                                        name="visible_para_analista" id="checkA">
                                                    <label class="form-check-label small" for="checkA">Ver
                                                        Analista</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox"
                                                        name="visible_para_cliente" id="checkC">
                                                    <label class="form-check-label small" for="checkC">Ver
                                                        Cliente</label>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group">
                                {% for doc in documents %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light p-2 rounded me-3 text-danger"><i
                                                class="bi bi-file-earmark-pdf fs-5"></i></div>
                                        <div>
                                            <div class="fw-bold text-truncate" style="max-width: 250px;">{{
                                                doc.filename.split('_', 2)[-1] }}</div>
                                            <div class="small text-muted">Por: {{ doc.uploaded_by.nombre_completo }} |
                                                {{ doc.created_at.strftime('%Y-%m-%d') }}</div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        {% if current_user.rol == 'Abogado' %}
                                        <button
                                            class="btn btn-sm btn-outline-{{ 'success' if doc.visible_para_analista else 'secondary' }} border-0"
                                            onclick="toggleVisibility('{{ doc.id }}', this, 'analyst')"
                                            title="Visibilidad Analista"><i class="bi bi-eye"></i></button>
                                        <button
                                            class="btn btn-sm btn-outline-{{ 'primary' if doc.visible_para_cliente else 'secondary' }} border-0"
                                            onclick="toggleVisibility('{{ doc.id }}', this, 'client')"
                                            title="Visibilidad Cliente"><i class="bi bi-person"></i></button>
                                        {% endif %}
                                        <a href="{{ url_for('main.download_file', filename=doc.filename) }}"
                                            class="btn btn-light btn-sm"><i class="bi bi-download"></i></a>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-5">No hay documentos guardados.</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- TAB 4: CHAT -->
                        <div class="tab-pane fade" id="chat" role="tabpanel">
                            <div class="chat-container">
                                <div class="chat-messages mb-3 border" id="chatMessages">
                                    {% for msg in messages %}
                                    {% set is_me = msg.sender_id == current_user.id %}
                                    <div
                                        class="d-flex {{ 'justify-content-end' if is_me else 'justify-content-start' }} mb-2">
                                        <div class="chat-bubble {{ 'chat-me' if is_me else 'chat-other' }}">
                                            <div class="fw-bold small mb-1">{{ 'Yo' if is_me else
                                                msg.sender.nombre_completo }}</div>
                                            {{ msg.content }}
                                            <div class="text-end" style="font-size: 0.7rem; opacity: 0.6;">{{
                                                msg.timestamp.strftime('%d/%m %H:%M') }}</div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center text-muted mt-5">No hay mensajes en el historial.</div>
                                    {% endfor %}
                                </div>
                                <form action="{{ url_for('chat.send_message', client_id=client.id) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="content"
                                            placeholder="Escribe un mensaje..." required autocomplete="off">
                                        <button class="btn btn-dark" type="submit"><i class="bi bi-send"></i></button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Profile -->
<div class="modal fade" id="editGeneralInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Información</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.edit_client', client_id=client.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" name="nombre" value="{{ client.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" name="telefono" value="{{ client.telefono }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" value="{{ client.email }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N° Contrato</label>
                        <input type="text" class="form-control" name="contract_number"
                            value="{{ client.contract_number or '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

</div>

<!-- Appointment Modal (Internal) -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Agendar Reunión (Staff)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted small">Agendando en nombre del cliente: <strong>{{ client.nombre }}</strong></p>

                <form id="bookingForm" action="{{ url_for('appointments.book_appointment', client_id=client.id) }}"
                    method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="time" id="selectedTime">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Fecha</label>
                        <input type="date" class="form-control" name="date" id="apptDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Horas Disponibles</label>
                        <div id="slotsContainer" class="d-grid gap-2" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="text-center text-muted small p-2 border rounded" style="grid-column: span 2;">
                                Selecciona una fecha...</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // JS for Visibility Toggle & Contract Calc (Dynamic)
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Chat Scroll ---
        var chatBox = document.getElementById('chatMessages');
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

        // --- 2. Contract Percentage Calc & Dynamic Rows ---
        const valorTotalInput = document.getElementById('valorTotalContract');
        const percentageDisplay = document.getElementById('porcentajeDisplay');
        const container = document.getElementById('dynamicInstallmentsContainer');
        const tableBody = document.querySelector('#installmentsTable tbody');
        const btnAddQuota = document.getElementById('btnAddQuota');

        function calculate() {
            if (!valorTotalInput || !container) return;
            let total = parseFloat(valorTotalInput.value) || 0;
            if (total <= 0) { percentageDisplay.innerText = "0%"; return; }

            let paid = 0;
            const inputs = container.querySelectorAll('input[name$="_valor"]');

            // --- 3. Appointment System Logic ---
            const apptInput = document.getElementById('apptDate');
            const slotsDiv = document.getElementById('slotsContainer');
            const bkForm = document.getElementById('bookingForm');
            const timeInp = document.getElementById('selectedTime');

            if (apptInput) {
                const today = new Date().toISOString().split('T')[0];
                apptInput.setAttribute('min', today);

                apptInput.addEventListener('change', function () {
                    const dateVal = this.value;
                    if (!dateVal) return;

                    slotsDiv.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

                    fetch(`/api/slots/{{ client.id }}?date=${dateVal}`)
                        .then(res => res.json())
                        .then(data => {
                            slotsDiv.innerHTML = '';
                            if (data.length === 0) {
                                slotsDiv.innerHTML = '<div class="alert alert-warning small text-center mb-0" style="grid-column: span 2;">Sin disponibilidad.</div>';
                                return;
                            }
                            data.forEach(s => {
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.className = 'btn btn-outline-dark btn-sm';
                                btn.innerText = s.label;
                                btn.onclick = () => {
                                    if (confirm(`¿Agendar cita para el ${dateVal} a las ${s.label}?`)) {
                                        timeInp.value = s.time;
                                        bkForm.submit();
                                    }
                                };
                                slotsDiv.appendChild(btn);
                            });
                        })
                        .catch(e => {
                            console.error(e);
                            slotsDiv.innerHTML = '<div class="text-danger small">Error.</div>';
                        });
                });
            }
            inputs.forEach(input => {
                const nameParts = input.name.split('_'); // cuota_1_valor
                const idx = nameParts[1];
                const stateSelect = container.querySelector(`select[name="cuota_${idx}_estado"]`);

                if (stateSelect && stateSelect.value === 'Pagada') {
                    paid += parseFloat(input.value) || 0;
                }
            });

            let pct = (paid / total) * 100;
            percentageDisplay.innerText = pct.toFixed(0) + "%";
            // Color code
            percentageDisplay.className = pct >= 100 ? 'text-success m-0 fw-bold' : (pct > 0 ? 'text-primary m-0' : 'text-muted m-0');
        }

        // Add New Quota Logic
        if (btnAddQuota && tableBody) {
            btnAddQuota.addEventListener('click', function () {
                // Find Max Index
                let maxIndex = 0;
                tableBody.querySelectorAll('tr[data-index]').forEach(row => {
                    const idx = parseInt(row.getAttribute('data-index'));
                    if (idx > maxIndex) maxIndex = idx;
                });
                const newIndex = maxIndex + 1;

                // Create Row HTML
                const row = document.createElement('tr');
                row.setAttribute('data-index', newIndex);
                row.innerHTML = `
                    <td>
                        <input type="text" class="form-control form-control-sm"
                            name="cuota_${newIndex}_concepto" value="Cuota ${newIndex}">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm"
                            name="cuota_${newIndex}_valor" placeholder="$">
                    </td>
                    <td>
                        <input type="date" class="form-control form-control-sm"
                            name="cuota_${newIndex}_fecha">
                    </td>
                    <td>
                        <select class="form-select form-select-sm" name="cuota_${newIndex}_metodo">
                            <option value="" disabled selected>-</option>
                            <option value="Nequi">Nequi</option>
                            <option value="Daviplata">Daviplata</option>
                            <option value="Bancolombia">Bancolombia</option>
                            <option value="Link de pago">Link de pago</option>
                            <option value="Efectivo">Efectivo</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" name="cuota_${newIndex}_estado">
                            <option value="Pendiente" selected>Pendiente</option>
                            <option value="Pagada">Pagada</option>
                            <option value="En Mora">Mora</option>
                            <option value="Anulada">Anulada</option>
                        </select>
                    </td>
                    <td class="text-end"></td>
                `;

                tableBody.appendChild(row);

                // Re-bind events for new inputs
                bindEvents(row);
                calculate();
            });
        }

        function bindEvents(parent) {
            parent.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', calculate);
                el.addEventListener('input', calculate);
            });
        }

        if (container) {
            bindEvents(container);
        }
        if (valorTotalInput) valorTotalInput.addEventListener('input', calculate);

        // Init
        calculate();
    });

    // --- 3. Toggle Visibility AJAX ---
    function toggleVisibility(docId, btn, type) {
        const endpoint = type === 'analyst'
            ? `/document/${docId}/toggle_analyst_visibility`
            : `/document/${docId}/toggle_client_visibility`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (type === 'analyst') {
                        btn.classList.toggle('btn-outline-success');
                        btn.classList.toggle('btn-outline-secondary');
                    } else {
                        btn.classList.toggle('btn-outline-primary');
                        btn.classList.toggle('btn-outline-secondary');
                    }
                }
            });
    }
</script>
<!-- Management History Note Section -->
{% if current_user.rol in ['Analista', 'Abogado', 'Admin', 'Aliado', 'Radicador'] %}
<div class="card shadow-sm mt-4 mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Historial de Gestión</h5>
    </div>
    <div class="card-body">
        <!-- Add Note Form -->
        <form action="{{ url_for('main.add_note', client_id=client.id) }}" method="POST" class="mb-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="mb-3">
                <label for="note_content" class="form-label fw-bold">Nueva Nota / Bitácora</label>
                <textarea class="form-control" id="note_content" name="note_content" rows="3"
                    placeholder="Escribe aquí los detalles de la gestión, llamada o actualización..."
                    required></textarea>
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i> Agregar Nota
                </button>
            </div>
        </form>

        <hr>

        <!-- Notes Timeline -->
        <h6 class="fw-bold mb-3">Bitácora de Actividades</h6>
        <div class="notes-timeline">
            {% if notes %}
            {% for note in notes %}
            <div class="card mb-3 border-0 bg-light">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold text-primary">
                            <i class="bi bi-person-circle me-1"></i> {{ note.author.nombre_completo }}
                        </span>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i> {{ note.timestamp.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                    </div>
                    <p class="mb-0 text-dark" style="white-space: pre-line;">{{ note.content }}</p>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center text-muted py-3">
                <i class="bi bi-journal-x fs-1 d-block mb-2"></i>
                No hay notas registradas para este caso.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}