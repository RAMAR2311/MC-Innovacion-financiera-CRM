{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Información del Cliente</h5>
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ client.nombre }}</h4>
                <p class="card-text"><strong>Email:</strong> {{ client.email }}</p>
                <p class="card-text"><strong>Teléfono:</strong> {{ client.telefono }}</p>
                <p class="card-text"><strong>ID:</strong> {{ client.tipo_id }} {{ client.numero_id }}</p>
                <p class="card-text"><strong>Ciudad:</strong> {{ client.ciudad }}</p>
                <p class="card-text"><strong>Registrado por:</strong> {{ client.analista.nombre_completo if
                    client.analista else 'Sistema' }}</p>
                <p class="card-text"><strong>Estado:</strong>
                    <span class="badge bg-secondary">{{ client.estado }}</span>
                </p>
                <hr>
                <h6>Motivo de Consulta:</h6>
                <p>{{ client.motivo_consulta }}</p>
            </div>
        </div>

        {% if current_user.rol == 'Admin' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Acceso al Portal</h5>
            </div>
            <div class="card-body">
                {% if client.login_user_id %}
                <p class="text-success fw-bold">Acceso Habilitado</p>
                <p class="small mb-0">Usuario vinculado:</p>
                <p class="fw-bold">{{ client.login_user.email }}</p>
                {% else %}
                <p class="small">Este cliente AÚN NO tiene acceso al portal.</p>
                <form action="{{ url_for('main.generate_client_access', client_id=client.id) }}" method="POST">
                    <button type="submit" class="btn btn-warning w-100">
                        Crear Usuario de Acceso
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if current_user.rol == 'Admin' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Acciones</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.update_status', client_id=client.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="new_status" class="form-label">Cambiar Estado</label>
                        <select class="form-select" name="new_status">
                            <option value="Pendiente_Analisis" {% if client.estado=='Pendiente_Analisis' %}selected{%
                                endif %}>Pendiente Análisis</option>
                            <option value="Con_Contrato" {% if client.estado=='Con_Contrato' %}selected{% endif %}>Con
                                Contrato</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Actualizar Estado</button>
                </form>
            </div>
        </div>
        {% endif %}

        {% if current_user.rol == 'Abogado' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Gestión del Caso</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.update_status', client_id=client.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="new_status" class="form-label">Cambiar Estado</label>
                        <select class="form-select" name="new_status">
                            <option value="Pendiente_Analisis" {% if client.estado=='Pendiente_Analisis' %}selected{%
                                endif %}>Pendiente Análisis</option>
                            <option value="Con_Analisis" {% if client.estado=='Con_Analisis' %}selected{% endif %}>Con
                                Análisis</option>
                            <option value="Con_Contrato" {% if client.estado=='Con_Contrato' %}selected{% endif %}>Con
                                Contrato</option>
                            <option value="Radicado" {% if client.estado=='Radicado' %}selected{% endif %}>Radicado
                            </option>
                            <option value="Finalizado" {% if client.estado=='Finalizado' %}selected{% endif %}>
                                Finalizado</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Actualizar Estado</button>
                </form>
            </div>
        </div>
        {% endif %}


        {% if current_user.rol == 'Analista' and client.estado in ['Nuevo', 'Informacion_Incompleta'] %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Acciones de Analista</h5>
            </div>
            <div class="card-body">
                <p>Una vez completada la revisión inicial, envía el caso al departamento legal.</p>
                <form action="{{ url_for('main.send_to_lawyer', client_id=client.id) }}" method="POST">
                    <button type="submit" class="btn btn-dark w-100">Enviar a Abogado</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Archivos y Documentos</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.upload_file', client_id=client.id) }}" method="POST"
                    enctype="multipart/form-data" class="mb-4 p-3 bg-light border rounded">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-5">
                            <label class="form-label small fw-bold">Archivo</label>
                            <input type="file" class="form-control form-control-sm" name="file" required>
                        </div>
                        {% if current_user.rol == 'Abogado' %}
                        <div class="col-md-5">
                            <label class="form-label small fw-bold d-block">Visibilidad</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="visible_para_analista"
                                    id="checkAnalista">
                                <label class="form-check-label small" for="checkAnalista">Analista</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="visible_para_cliente"
                                    id="checkCliente">
                                <label class="form-check-label small" for="checkCliente">Cliente</label>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-2 text-end">
                            <label class="form-label d-block">&nbsp;</label>
                            <button type="submit" class="btn btn-sm btn-primary w-100">Subir</button>
                        </div>
                    </div>
                </form>

                <h6>Documentos:</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre del Archivo</th>
                                <th>Subido Por</th>
                                <th class="text-center" style="width: 100px;">Analista</th>
                                <th class="text-center" style="width: 100px;">Cliente</th>
                                <th class="text-center" style="width: 80px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr>
                                <td class="text-truncate" style="max-width: 200px;" title="{{ doc.filename }}">
                                    {{ doc.filename.split('_', 2)[-1] }}
                                </td>
                                <td><small>{{ doc.uploaded_by.nombre_completo }}</small></td>
                                <td class="text-center">
                                    {% if current_user.rol == 'Abogado' %}
                                    <button
                                        class="btn btn-sm btn-outline-{{ 'success' if doc.visible_para_analista else 'secondary' }} border-0"
                                        onclick="toggleVisibility({{ doc.id }}, this, 'analyst')"
                                        title="{{ 'Visible' if doc.visible_para_analista else 'Oculto' }}">
                                        <i class="bi bi-eye{{ '' if doc.visible_para_analista else '-slash' }}"></i>
                                    </button>
                                    {% else %}
                                    {% if doc.visible_para_analista %}
                                    <span class="badge bg-success"><i class="bi bi-eye"></i></span>
                                    {% else %}
                                    <span class="badge bg-secondary"><i class="bi bi-eye-slash"></i></span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if current_user.rol == 'Abogado' %}
                                    <button
                                        class="btn btn-sm btn-outline-{{ 'primary' if doc.visible_para_cliente else 'secondary' }} border-0"
                                        onclick="toggleVisibility({{ doc.id }}, this, 'client')"
                                        title="{{ 'Visible' if doc.visible_para_cliente else 'Oculto' }}">
                                        <i class="bi bi-person{{ '-check' if doc.visible_para_cliente else '-x' }}"></i>
                                    </button>
                                    {% else %}
                                    {% if doc.visible_para_cliente %}
                                    <span class="badge bg-primary"><i class="bi bi-person-check"></i></span>
                                    {% else %}
                                    <span class="badge bg-secondary"><i class="bi bi-person-x"></i></span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('main.download_file', filename=doc.filename) }}"
                                        class="btn btn-sm btn-light text-secondary">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">No hay documentos registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <script>
                    function toggleVisibility(docId, btn, type) {
                        const endpoint = type === 'analyst'
                            ? `/document/${docId}/toggle_analyst_visibility`
                            : `/document/${docId}/toggle_client_visibility`;

                        fetch(endpoint, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const icon = btn.querySelector('i');
                                    if (type === 'analyst') {
                                        if (data.visible) {
                                            btn.classList.replace('btn-outline-secondary', 'btn-outline-success');
                                            icon.className = 'bi bi-eye';
                                        } else {
                                            btn.classList.replace('btn-outline-success', 'btn-outline-secondary');
                                            icon.className = 'bi bi-eye-slash';
                                        }
                                    } else {
                                        if (data.visible) {
                                            btn.classList.replace('btn-outline-secondary', 'btn-outline-primary');
                                            icon.className = 'bi bi-person-check';
                                        } else {
                                            btn.classList.replace('btn-outline-primary', 'btn-outline-secondary');
                                            icon.className = 'bi bi-person-x';
                                        }
                                    }
                                } else {
                                    alert('Error al actualizar visibilidad');
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                </script>
            </div>
        </div>

        <!-- Financial Information Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Información Financiera y Análisis</h5>
            </div>
            <div class="card-body">
                <!-- Add Obligation Form (Visible to All Authorized Roles) -->
                <h6 class="mb-3">Agregar Nueva Obligación</h6>
                <form action="{{ url_for('main.add_financial_obligation', client_id=client.id) }}" method="POST"
                    class="row g-3 mb-4 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Entidad</label>
                        <input type="text" class="form-control" name="entidad" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado de la Deuda</label>
                        <select class="form-select" name="estado" required>
                            <option value="" selected disabled>Seleccionar...</option>
                            <option value="Al día">Al día</option>
                            <option value="Mora">Mora</option>
                            <option value="Castigada">Castigada</option>
                            <option value="Reportado">Reportado</option>
                            <option value="Juridico">Jurídico</option>
                            <option value="Dudoso recaudo">Dudoso recaudo</option>
                            <option value="Recuperado">Recuperado</option>
                            <option value="Penalizado">Penalizado</option>
                            <option value="Comparendos">Comparendos</option>
                            <option value="Negociación">Negociación</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" name="valor" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Estado con Nosotros</label>
                        <select class="form-select" name="estado_legal" required>
                            <option value="Sin Iniciar">Sin Iniciar</option>
                            <option value="Derecho de aclaración">Derecho de aclaración</option>
                            <option value="Refutación de pruebas">Refutación de pruebas</option>
                            <option value="Derecho de petición">Derecho de petición</option>
                            <option value="Fallo al derecho">Fallo al derecho</option>
                            <option value="Refutación a ese fallo">Refutación a ese fallo</option>
                            <option value="Solicitud de reposición">Solicitud de reposición</option>
                            <option value="Queja superintendencia">Queja superintendencia</option>
                            <option value="Queja defensoría">Queja defensoría</option>
                            <option value="Tutelas fallo">Tutelas fallo</option>
                            <option value="Tutela">Tutela</option>
                            <option value="Demanda juzgado">Demanda juzgado</option>
                            <option value="Demanda a la SIC">Demanda a la SIC</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Agregar</button>
                    </div>
                </form>

                <hr>

                <!-- Obligations Table -->
                <h6 class="mb-3">Obligaciones Registradas</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Entidad</th>
                                <th>Estado Deuda</th>
                                <th>Valor</th>
                                <th style="width: 200px;">Estado con Nosotros</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for obligation in client.financial_obligations %}
                            <tr>
                                <td>{{ obligation.entidad }}</td>
                                <td>{{ obligation.estado }}</td>
                                <td>${{ "{:,.0f}".format(obligation.valor) }}</td>
                                <td>
                                    <form
                                        action="{{ url_for('main.update_legal_status', obligation_id=obligation.id) }}"
                                        method="POST">
                                        <select class="form-select form-select-sm" name="estado_legal"
                                            onchange="this.form.submit()">
                                            <option value="Sin Iniciar" {% if obligation.estado_legal=='Sin Iniciar'
                                                %}selected{% endif %}>Sin Iniciar</option>
                                            <option value="Derecho de aclaración" {% if
                                                obligation.estado_legal=='Derecho de aclaración' %}selected{% endif %}>
                                                Derecho de aclaración</option>
                                            <option value="Refutación de pruebas" {% if
                                                obligation.estado_legal=='Refutación de pruebas' %}selected{% endif %}>
                                                Refutación de pruebas</option>
                                            <option value="Derecho de petición" {% if
                                                obligation.estado_legal=='Derecho de petición' %}selected{% endif %}>
                                                Derecho de petición</option>
                                            <option value="Fallo al derecho" {% if
                                                obligation.estado_legal=='Fallo al derecho' %}selected{% endif %}>Fallo
                                                al derecho</option>
                                            <option value="Refutación a ese fallo" {% if
                                                obligation.estado_legal=='Refutación a ese fallo' %}selected{% endif %}>
                                                Refutación a ese fallo</option>
                                            <option value="Solicitud de reposición" {% if
                                                obligation.estado_legal=='Solicitud de reposición' %}selected{% endif
                                                %}>Solicitud de reposición</option>
                                            <option value="Queja superintendencia" {% if
                                                obligation.estado_legal=='Queja superintendencia' %}selected{% endif %}>
                                                Queja superintendencia</option>
                                            <option value="Queja defensoría" {% if
                                                obligation.estado_legal=='Queja defensoría' %}selected{% endif %}>Queja
                                                defensoría</option>
                                            <option value="Tutelas fallo" {% if obligation.estado_legal=='Tutelas fallo'
                                                %}selected{% endif %}>Tutelas fallo</option>
                                            <option value="Tutela" {% if obligation.estado_legal=='Tutela' %}selected{%
                                                endif %}>Tutela</option>
                                            <option value="Demanda juzgado" {% if
                                                obligation.estado_legal=='Demanda juzgado' %}selected{% endif %}>Demanda
                                                juzgado</option>
                                            <option value="Demanda a la SIC" {% if
                                                obligation.estado_legal=='Demanda a la SIC' %}selected{% endif %}>
                                                Demanda a la SIC</option>
                                            <option value="Finalizado" {% if obligation.estado_legal=='Finalizado'
                                                %}selected{% endif %}>Finalizado</option>
                                        </select>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay obligaciones registradas todavía.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <hr>

                <!-- Analysis Conclusion -->
                <h6 class="mb-3">Conclusión del Análisis</h6>
                {% if current_user.rol in ['Analista', 'Abogado'] %}
                <form action="{{ url_for('main.update_analysis', client_id=client.id) }}" method="POST">
                    <div class="mb-3">
                        <textarea class="form-control" name="conclusion_analisis" rows="3"
                            placeholder="Escribe aquí el análisis del caso...">{{ client.conclusion_analisis or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-secondary">Guardar Análisis</button>
                </form>
                {% else %}
                <div class="p-3 bg-light border rounded">
                    {{ client.conclusion_analisis or 'Sin análisis registrado.' }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Payments and Contracting Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">PAGOS</h5>
            </div>
            <div class="card-body">
                {% set is_analyst = current_user.rol == 'Analista' %}

                <!-- Diagnosis Section -->
                <h6 class="mb-3">Diagnóstico Inicial</h6>
                <form action="{{ url_for('main.save_payment_diagnosis', client_id=client.id) }}" method="POST"
                    class="mb-4">
                    <fieldset {% if is_analyst %}disabled{% endif %}>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Valor Diagnóstico</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control" name="valor"
                                        value="{{ client.payment_diagnosis.valor if client.payment_diagnosis else '' }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha de Pago</label>
                                <input type="date" class="form-control" name="fecha_pago"
                                    value="{{ client.payment_diagnosis.fecha_pago if client.payment_diagnosis else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Método de Pago</label>
                                <select class="form-select" name="metodo_pago">
                                    <option value="" selected disabled>Seleccionar...</option>
                                    {% for metodo in ['Nequi', 'Daviplata', 'Bancolombia', 'Link de pago', 'Efectivo']
                                    %}
                                    <option value="{{ metodo }}" {% if client.payment_diagnosis and
                                        client.payment_diagnosis.metodo_pago==metodo %}selected{% endif %}>
                                        {{ metodo }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="verificado"
                                        id="checkVerificado" {% if client.payment_diagnosis and
                                        client.payment_diagnosis.verificado %}checked{% endif %}>
                                    <label class="form-check-label" for="checkVerificado">
                                        Pago Verificado
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% if not is_analyst %}
                        <div class="mt-2 text-end">
                            <button type="submit" class="btn btn-sm btn-primary">Guardar Diagnóstico</button>
                        </div>
                        {% endif %}
                    </fieldset>
                </form>

                <hr>

                <!-- Contract Section -->
                <!-- Contract Section -->
                <h6 class="mb-3">Contrato y Cuotas (Fijo: 6 Cuotas)</h6>
                <form action="{{ url_for('main.save_contract_details', client_id=client.id) }}" method="POST"
                    id="contractForm">
                    <fieldset {% if is_analyst %}disabled{% endif %}>

                        <!-- Header with Total -->
                        <div class="row g-3 mb-3 p-3 bg-light rounded border">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Valor Total Contrato</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control" name="valor_total"
                                        id="valorTotalContract"
                                        value="{{ client.payment_contract.valor_total if client.payment_contract else '' }}"
                                        required>
                                </div>
                            </div>
                            <!-- Swapped "Number of Quotas" for "Percentage" as requested -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Porcentaje Pagado</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-end bg-white" id="porcentajePagado"
                                        value="0%" readonly style="font-weight: bold; color: green;">
                                    <span class="input-group-text">%</span>
                                </div>
                                <input type="hidden" name="numero_cuotas" value="6">
                            </div>
                        </div>

                        <!-- Static 6 Installment Rows -->
                        <div id="staticInstallmentsContainer">
                            {% set installments_map = {} %}
                            {% if client.payment_contract and client.payment_contract.installments %}
                            {% for inst in client.payment_contract.installments %}
                            {% set _ = installments_map.update({inst.numero_cuota: inst}) %}
                            {% endfor %}
                            {% endif %}

                            {% for i in range(1, 7) %}
                            {% set inst = installments_map.get(i) %}
                            <div class="row g-2 mb-2 align-items-center p-2 border-bottom">
                                <div class="col-auto" style="width: 80px;">
                                    <span class="badge bg-secondary w-100">Cuota {{ i }}</span>
                                </div>
                                <div class="col">
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        name="cuota_{{ i }}_valor" placeholder="Valor"
                                        value="{{ inst.valor if inst else '' }}">
                                </div>
                                <div class="col">
                                    <input type="date" class="form-control form-control-sm" name="cuota_{{ i }}_fecha"
                                        value="{{ inst.fecha_vencimiento if inst and inst.fecha_vencimiento else '' }}">
                                </div>
                                <div class="col">
                                    <select class="form-select form-select-sm" name="cuota_{{ i }}_metodo">
                                        {% set metodo = inst.metodo_pago if inst else '' %}
                                        <option value="" disabled {% if not metodo %}selected{% endif %}>Método</option>
                                        <option value="Nequi" {% if metodo=='Nequi' %}selected{% endif %}>Nequi</option>
                                        <option value="Daviplata" {% if metodo=='Daviplata' %}selected{% endif %}>
                                            Daviplata</option>
                                        <option value="Bancolombia" {% if metodo=='Bancolombia' %}selected{% endif %}>
                                            Bancolombia</option>
                                        <option value="Link de pago" {% if metodo=='Link de pago' %}selected{% endif %}>
                                            Link de pago</option>
                                        <option value="Efectivo" {% if metodo=='Efectivo' %}selected{% endif %}>Efectivo
                                        </option>
                                    </select>
                                </div>
                                <div class="col">
                                    <select class="form-select form-select-sm" name="cuota_{{ i }}_estado">
                                        {% set estado = inst.estado if inst else '' %}
                                        <option value="" {% if not estado %}selected{% endif %}>Estado (Seleccionar)
                                        </option>
                                        <option value="Pendiente" {% if estado=='Pendiente' %}selected{% endif %}>
                                            Pendiente</option>
                                        <option value="Pagada" {% if estado=='Pagada' %}selected{% endif %}>Pagada
                                        </option>
                                        <option value="En Mora" {% if estado=='En Mora' %}selected{% endif %}>En Mora
                                        </option>
                                    </select>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% if not is_analyst %}
                        <div class="mt-3 text-end">
                            <button type="submit" class="btn btn-primary">Guardar Contrato y Cuotas</button>
                        </div>
                        {% endif %}
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block content_end %}
    {% endblock %}

    {% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const valorTotalInput = document.getElementById('valorTotalContract');
            const porcentajeOutput = document.getElementById('porcentajePagado');
            // Container for the static 6 rows
            const container = document.getElementById('staticInstallmentsContainer');

            function calcularPorcentaje() {
                const totalContrato = parseFloat(valorTotalInput ? valorTotalInput.value : 0) || 0;

                if (totalContrato <= 0) {
                    if (porcentajeOutput) porcentajeOutput.value = "0%";
                    return;
                }

                let totalRecaudado = 0;

                // Iterate through the 6 static rows to sum paid amounts
                for (let i = 1; i <= 6; i++) {
                    // Selectors based on the static HTML naming convention: cuota_{i}_valor and cuota_{i}_estado
                    const valInput = container ? container.querySelector(`input[name="cuota_${i}_valor"]`) : null;
                    const stateSelect = container ? container.querySelector(`select[name="cuota_${i}_estado"]`) : null;

                    if (valInput && stateSelect && stateSelect.value === 'Pagada') {
                        totalRecaudado += parseFloat(valInput.value) || 0;
                    }
                }

                const porcentaje = (totalRecaudado / totalContrato) * 100;
                const display = Number.isInteger(porcentaje) ? porcentaje : porcentaje.toFixed(1);
                if (porcentajeOutput) porcentajeOutput.value = display + "%";
            }

            function bindCalculationEvents() {
                if (!container) return;

                // Select all relevant inputs within the container
                const inputs = container.querySelectorAll('input[name$="_valor"], select[name$="_estado"]');

                inputs.forEach(el => {
                    // Bind both input and change for robustness
                    el.addEventListener('input', calcularPorcentaje);
                    el.addEventListener('change', calcularPorcentaje);
                });
            }

            if (valorTotalInput) {
                valorTotalInput.addEventListener('input', calcularPorcentaje);
            }

            // Initial Bind and Calculate
            bindCalculationEvents();
            calcularPorcentaje();
        });
    </script>
    {% endblock %}