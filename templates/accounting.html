{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Contabilidad y Finanzas</h2>

<!-- Filter Form -->
<form method="GET" class="row g-2 mb-4 align-items-center bg-light p-3 rounded border">
    <div class="col-auto">
        <label for="start_date" class="col-form-label fw-bold">Fecha Inicio</label>
    </div>
    <div class="col-auto">
        <input type="date" class="form-control form-control-sm" name="start_date" value="{{ start_date or '' }}">
    </div>
    <div class="col-auto">
        <label for="end_date" class="col-form-label fw-bold">Fecha Fin</label>
    </div>
    <div class="col-auto">
        <input type="date" class="form-control form-control-sm" name="end_date" value="{{ end_date or '' }}">
    </div>
    <div class="col-auto">
        <label for="estado_cuota" class="col-form-label fw-bold ms-2">Estado Cuota:</label>
    </div>
    <div class="col-auto">
        <select name="estado_cuota" id="estado_cuota" class="form-select form-select-sm">
            <option value="todos" {% if current_filter=='todos' or not current_filter %}selected{% endif %}>
                Todas</option>
            <option value="Pagada" {% if current_filter=='Pagada' %}selected{% endif %}>Pagada</option>
            <option value="Pendiente" {% if current_filter=='Pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="En Mora" {% if current_filter=='En Mora' %}selected{% endif %}>En Mora</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-primary">Filtrar</button>
    </div>
</form>

<!-- Section A: KPIs -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3">
            <div class="card-header">Diagnósticos Vendidos</div>
            <div class="card-body">
                <h3 class="card-title">${{ "{:,.0f}".format(income_diagnosis) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Cuotas Recaudadas</div>
            <div class="card-body">
                <h3 class="card-title">${{ "{:,.0f}".format(income_installments) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-dark mb-3">
            <div class="card-header">Ingreso Total Bruto</div>
            <div class="card-body">
                <h3 class="card-title">${{ "{:,.0f}".format(total_gross_income) }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Section B: Funnel -->
<h3 class="mb-3">Embudo de Clientes</h3>
<div class="row mb-4">
    {% for status, count in funnel_stats.items() %}
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-body text-center">
                <h5 class="card-title">{{ count }}</h5>
                <p class="card-text">{{ status.replace('_', ' ') }}</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Section C: Tables -->
<div class="row">
    <div class="col-md-6">
        <h4>Diagnósticos Pagados</h4>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Método</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in recent_diagnoses.items %}
                    <tr>
                        <td>{{ p.fecha_pago }}</td>
                        <td>{{ p.client.nombre }}</td>
                        <td>{{ p.metodo_pago }}</td>
                        <td>${{ "{:,.0f}".format(p.valor) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls for Diagnoses -->
        {% if recent_diagnoses.pages > 1 %}
        <nav aria-label="Page navigation" class="mt-2">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item {% if not recent_diagnoses.has_prev %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('financial.accounting_dashboard', page_diag=recent_diagnoses.prev_num, page_inst=request.args.get('page_inst', 1), start_date=start_date, end_date=end_date, estado_cuota=current_filter) if recent_diagnoses.has_prev else '#' }}">Anterior</a>
                </li>
                <li class="page-item disabled"><span class="page-link">{{ recent_diagnoses.page }} / {{
                        recent_diagnoses.pages }}</span></li>
                <li class="page-item {% if not recent_diagnoses.has_next %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('financial.accounting_dashboard', page_diag=recent_diagnoses.next_num, page_inst=request.args.get('page_inst', 1), start_date=start_date, end_date=end_date, estado_cuota=current_filter) if recent_diagnoses.has_next else '#' }}">Siguiente</a>
                </li>
            </ul>
        </nav>
        {% endif %}

    </div>
    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Historial de Cuotas</h4>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Cuota</th>
                        <th>Estado</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in recent_installments.items %}
                    <tr>

                        <td>{{ c.fecha_vencimiento }}</td>
                        <td>{{ c.payment_contract.client.nombre }}</td>
                        <td>{{ c.numero_cuota }}</td>
                        <td>
                            {% if c.estado == 'Pagada' %}
                            <span class="badge bg-success">Pagada</span>
                            {% elif c.estado == 'En Mora' %}
                            <span class="badge bg-danger">En Mora</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ c.estado }}</span>
                            {% endif %}
                        </td>
                        <td>${{ "{:,.0f}".format(c.valor) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls for Installments -->
        {% if recent_installments.pages > 1 %}
        <nav aria-label="Page navigation" class="mt-2">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item {% if not recent_installments.has_prev %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('financial.accounting_dashboard', page_inst=recent_installments.prev_num, page_diag=request.args.get('page_diag', 1), start_date=start_date, end_date=end_date, estado_cuota=current_filter) if recent_installments.has_prev else '#' }}">Anterior</a>
                </li>
                <li class="page-item disabled"><span class="page-link">{{ recent_installments.page }} / {{
                        recent_installments.pages }}</span></li>
                <li class="page-item {% if not recent_installments.has_next %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('financial.accounting_dashboard', page_inst=recent_installments.next_num, page_diag=request.args.get('page_diag', 1), start_date=start_date, end_date=end_date, estado_cuota=current_filter) if recent_installments.has_next else '#' }}">Siguiente</a>
                </li>
            </ul>
        </nav>
        {% endif %}

    </div>
</div>
{% endblock %}